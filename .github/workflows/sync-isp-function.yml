name: Sync ISP Function

on:
  push:
    paths:
      - 'Surge/Module/Panel/IP-info/Moore/IP-1.js'
    workflow_dispatch:  # 允许手动触发
      inputs:
        description:
          description: 'Optional description'
          required: false

jobs:
  sync-function:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Sync ISP function to other files
      run: |
        # Define the file paths
        SOURCE_FILE="Surge/Module/Panel/IP-info/Moore/IP-1.js"
        TARGET_FILES=("Surge/Module/Panel/IP-info/Moore/IP-2.js" "Surge/Module/Panel/IP-info/Moore/IP-3.js" "Surge/Module/Panel/IP-info/Moore/IP-4.js")

        # Extract the cleanIspInfo function from the source file
        FUNCTION_CODE=$(sed -n '/function cleanIspInfo/,/^}/p' $SOURCE_FILE)

        # Iterate over the target files and replace the cleanIspInfo function
        for TARGET_FILE in "${TARGET_FILES[@]}"; do
          # Use sed to replace the old function with the new one
          sed -i '/function cleanIspInfo/,/^}/c\'"$FUNCTION_CODE"'' $TARGET_FILE
        done

        # Check if there are any changes
        if [ -n "$(git status --porcelain)" ]; then
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Sync cleanIspInfo function from IP-1.js to IP-2.js, IP-3.js, IP-4.js"
          git push
        else
          echo "No changes detected"
        fi
